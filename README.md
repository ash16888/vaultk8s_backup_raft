<h2>Бэкап и восстановление Hashicorp Vault  Raft storage в Kubernetes</h2>

<h2>БЭКАП</h2>

Open source  версия Hashicorp Vault не предоставляет готового решения для автоматического резервного копирования. Это предложение доступно только в Vault Enterprise .

Тем не менее, функция резервного копирования доступна из cli и HTTP API, но не автоматизирована. Будем использовать сохранение снапшота для автоматического резервного копирования с помощью CronJob  Kubernetes. Задание cron будет ежедневно делать снапшоты и загружать их в  хранилище S3  в данном примере в Yandex Cloud.

<h3>Аутентификация</h3>

Создадим  политику для  выполнения задания резервного копирования.
для этого нужно будет выполнить несколько команд внутри одного из подов с vault
[Метод аутентификации AppRole](https://www.vaultproject.io/docs/auth/approle) идеально подходит для аутентификации снапшот агента.

`
echo '
path "sys/storage/raft/snapshot" {
   capabilities = ["read"]
}' | vault policy write snapshot -
`
`vault auth enable approle`

`vault write auth/approle/role/snapshot-agent token_ttl=2h token_policies=snapshot`

`vault read auth/approle/role/snapshot-agent/role-id -field=.data.role_id`

`vault write -f auth/approle/role/snapshot-agent/secret-id -field=.data.secret_id`

<h3>Подготовим секреты</h3>

Для этого  полученные значения, а также доступы к S3  нужно перевести в формат base64 и
добавить их в yaml файл  с секретами.

<h3>Кастомный контейнер</h3>
Кастомный образ контейнера собран на базе образа с aws cli .

В него добавлены  бинарники vault  и jq - утилиты для обработки json  файлов.

Пушим его в свой registry  или  используем уже готовый ash16888/vault-aws-jq:1.9.2

<h3>CronJob</h3>

Настроим  переменную окружения VAULT_ADDR  на http://vault-active.vault.svc.cluster.local:8200. Использование vault-active Service позволяет гарантировать, что запрос снапшота будет сделан для leader узла, при условии, что включен Service Registration , что, как правило является значением по умолчанию .

ВАЖНО !!! Точный URL-адрес может различаться в зависимости от названия деплоймента и используемого неймспейса.

Подробнее https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/

Используя ранее собранный образ cronjob  выполнит следующие команды:

Сгенерирует новый токен для vault и передаст его в переменные окружения.

Подключившись к raft кластеру vault создаст снапшот

Далее подключится к s3 бакету и скопирует снапшот добавив к имени файла текущие дату и время
Для упрощения восстановления скопируем полученный бэкап только уже под именем latestbackup.snap (при каждом выполнении джобы этот файл будет затираться новым)


Для того чтобы все заработало  остается только запустить  команду kubectl apply -f * 


<h2>ВОССТАНОВЛЕНИЕ</h2>
Загрузим  небольшой bash script в наш S3 бакет vaultrestore.sh

 Для восстановления бэкапа нам нужно задеплоить helm chart Vault дополнив  values.yaml значениями из файла valuesrestore.yaml

 Рассмотрим подробнее что будет происходить

 При установке чарта в кластер создается инит контейнер который скачивает два файла с S3 непосредственно снапшот с бэкапом и скрипт который мы загрузили ранее. Оба файла загружаются в emptyDir mounted volume 

 Затем стартует основной контейнер в который мы передадим команду postStart 
 которая запустит bash скрипт который в свою очередь инициализирует vault  залогинится и выполнит принудительную операцию восстановления бэкапа.
 
 Стоит отметить что ПОЛНОЕ автоматическое восстановление произойдет лишь в случае использования KMS auto-unseal.
 Соответственно если KMS auto-unseal изначально не использовался то необходимо произвести распечатывание vault используя ключи.

ВАЖНО для восстановления  необходимо чтобы новая инсталляция максимально соответствовала изначальной версии бэкап которой восстанавливается (т.е. механизм unseal, количество ключей, и т.д.)

